name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      PYTHONDONTWRITEBYTECODE: "1"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PIP_NO_PYTHON_VERSION_WARNING: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            services/spawn_service/requirements.txt
            services/orchestrator/requirements.txt
            services/scoreboard/requirements.txt
            scripts/requirements.txt

      - name: Install tooling + dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          # Tooling for safeguards
          pip install ruff pip-audit

          # Service deps (kept identical to your current behavior)
          pip install \
            -r services/spawn_service/requirements.txt \
            -r services/orchestrator/requirements.txt \
            -r services/scoreboard/requirements.txt
          if [ -f scripts/requirements.txt ]; then
            pip install -r scripts/requirements.txt
          fi

      # ---------------------------
      # Fast safeguards (fail early)
      # ---------------------------

      - name: Lint (static) - ruff
        shell: bash
        run: |
          set -euo pipefail
          # F821 catches "undefined name" (your exact class of breakage)
          ruff check . --select F,E9 --output-format=github

      - name: Lint (syntax) - compileall
        shell: bash
        run: |
          set -euo pipefail
          python -m compileall -q services scripts

      - name: Import smoke test (catches init-order issues)
        shell: bash
        run: |
          set -euo pipefail
          # Import the "risky" entrypoints directly; this is cheap and brutal.
          python -c "import services.spawn_service.app.main as m; assert hasattr(m, 'app')"
          python -c "import services.orchestrator.app.main as m; assert hasattr(m, 'app')"
          python -c "import services.scoreboard.app.main as m; assert hasattr(m, 'app')"

      - name: Secret scan (cheap regex gate)
        shell: bash
        run: |
          set -euo pipefail
          # ripgrep is installed on ubuntu-latest; if it ever isn't, CI deserves to fail.
          if rg -n --hidden --no-ignore-vcs \
            "BEGIN (RSA|OPENSSH|EC|DSA) PRIVATE KEY|AKIA[0-9A-Z]{16}|ASIA[0-9A-Z]{16}" .; then
            echo "Potential secret material detected."
            exit 1
          fi

      - name: Dependency vulnerability scan (pip-audit)
        shell: bash
        run: |
          set -euo pipefail
          # Audit each requirements file. This is fast enough for CI and catches obvious landmines.
          pip-audit -r services/spawn_service/requirements.txt
          pip-audit -r services/orchestrator/requirements.txt
          pip-audit -r services/scoreboard/requirements.txt
          pip-audit -r scripts/requirements.txt

      - name: CI fingerprint
        shell: bash
        run: |
          set -euo pipefail
          echo "ref=$GITHUB_REF sha=$GITHUB_SHA workflow=$GITHUB_WORKFLOW run_id=$GITHUB_RUN_ID"
          echo "ci_yml_sha=$(git rev-parse HEAD:.github/workflows/ci.yml 2>/dev/null || true)"
          python -V
          pip -V

      # ---------------------------
      # Policy checks (OPA)
      # ---------------------------

      - name: OPA policy tests (Rego v1)
        shell: bash
        run: |
          set -euo pipefail

          if rg -n --hidden --no-ignore-vcs '^\s*docker\b.*\bopa\b.*\btest\b.*--v1\b' .github/workflows; then
            echo "ERROR: '--v1' flag detected in a docker opa test command."
            exit 1
          fi

          if rg -n --hidden --no-ignore-vcs '^\s*(docker\s+run\b.*\bopa\b.*\btest\b.*--v1\b|\bopa\s+test\b.*--v1\b)' .github/workflows policies; then
            echo "ERROR: '--v1' flag detected in opa test command."
            exit 1
          fi

          OPA_IMAGE="openpolicyagent/opa@sha256:c0609fecc0924743f8648dc4a035d2f57ca163dc723ed1d13f3197ba5bd122b3"
          docker pull "$OPA_IMAGE"
          opa() { docker run --rm -v "$GITHUB_WORKSPACE:/workspace" -w /workspace "$OPA_IMAGE" "$@"; }

          opa version
          opa fmt --fail policies/
          opa test -v policies/

      # ---------------------------
      # Tests
      # ---------------------------

      - name: Unit tests (spawn_service)
        shell: bash
        run: |
          set -euo pipefail
          python -m unittest discover -s services/spawn_service/tests

      - name: Unit tests (orchestrator)
        shell: bash
        run: |
          set -euo pipefail
          python -m unittest discover -s services/orchestrator/tests

      - name: Unit tests (scoreboard)
        shell: bash
        run: |
          set -euo pipefail
          python -m unittest discover -s services/scoreboard/tests

      - name: Unit tests (scripts)
        shell: bash
        run: |
          set -euo pipefail
          python -m unittest discover -s scripts/tests
