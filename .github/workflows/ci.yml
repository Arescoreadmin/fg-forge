name: CI

on:
  push:
    branches: ["**"]
  pull_request:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      PYTHONDONTWRITEBYTECODE: "1"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PIP_NO_PYTHON_VERSION_WARNING: "1"
      PYTHONPATH: "."
      # Make runtime expectations explicit (don’t “accidentally dev”).
      FORGE_ENV: "dev"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            services/spawn_service/requirements.txt
            services/orchestrator/requirements.txt
            services/scoreboard/requirements.txt
            scripts/requirements.txt

      - name: Install system deps (ripgrep)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Install tooling + dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install ruff pip-audit

          # scripts deps (helpers/tests)
          if [ -f scripts/requirements.txt ]; then
            pip install -r scripts/requirements.txt
          fi

          # service deps
          pip install \
            -r services/spawn_service/requirements.txt \
            -r services/orchestrator/requirements.txt \
            -r services/scoreboard/requirements.txt

      # ---------------------------
      # Lint + formatting (fail early)
      # ---------------------------

      - name: Format (ruff)
        shell: bash
        run: |
          set -euo pipefail
          ruff format --check .

      - name: Lint (ruff)
        shell: bash
        run: |
          set -euo pipefail
          ruff check . --output-format=github

      - name: Lint (syntax) - compileall
        shell: bash
        run: |
          set -euo pipefail
          python -m compileall -q services scripts

      - name: Import smoke test (entrypoints)
        shell: bash
        run: |
          set -euo pipefail
          python -c "import services.spawn_service.app.main as m; assert hasattr(m, 'app')"
          python -c "import services.orchestrator.app.main as m; assert hasattr(m, 'app')"
          python -c "import services.scoreboard.app.main as m; assert hasattr(m, 'app')"

      - name: Secret scan (cheap regex gate)
        shell: bash
        run: |
          set -euo pipefail
          PATTERN='BEGIN (RSA|OPENSSH|EC|DSA) PRIVATE KEY|AKIA[0-9A-Z]{16}|ASIA[0-9A-Z]{16}'

          if rg -n --hidden --no-ignore-vcs \
            --glob '!.git/**' \
            --glob '!.venv/**' \
            --glob '!venv/**' \
            --glob '!**/__pycache__/**' \
            --glob '!**/*.pyc' \
            --glob '!node_modules/**' \
            --glob '!dist/**' \
            --glob '!build/**' \
            --glob '!storage/**' \
            "$PATTERN" .; then
            echo "Potential secret material detected."
            exit 1
          fi

      - name: Dependency vulnerability scan (pip-audit)
        shell: bash
        run: |
          set -euo pipefail

          # If you want strict mode, remove IGNORE_ARGS and fix deps instead.
          IGNORE_ARGS=(
            "--ignore-vuln" "PYSEC-2024-38"
            "--ignore-vuln" "CVE-2024-35195"
            "--ignore-vuln" "CVE-2024-47081"
            "--ignore-vuln" "CVE-2024-47881"
            "--ignore-vuln" "CVE-2025-54121"
            "--ignore-vuln" "CVE-2024-47874"
          )

          pip-audit -r services/spawn_service/requirements.txt "${IGNORE_ARGS[@]}"
          pip-audit -r services/orchestrator/requirements.txt "${IGNORE_ARGS[@]}"
          pip-audit -r services/scoreboard/requirements.txt "${IGNORE_ARGS[@]}"
          if [ -f scripts/requirements.txt ]; then
            pip-audit -r scripts/requirements.txt "${IGNORE_ARGS[@]}"
          fi

      - name: CI fingerprint
        shell: bash
        run: |
          set -euo pipefail
          echo "ref=$GITHUB_REF sha=$GITHUB_SHA workflow=$GITHUB_WORKFLOW run_id=$GITHUB_RUN_ID"
          echo "ci_yml_sha=$(git rev-parse HEAD:.github/workflows/ci.yml 2>/dev/null || true)"
          python -V
          pip -V
          ruff --version
          pip-audit --version

      # ---------------------------
      # Policy checks (OPA)
      # ---------------------------

      - name: OPA policy tests (Rego v1)
        shell: bash
        run: |
          set -euo pipefail

          # Guardrail: forbid --v1 flag usage in workflow/policies
          if rg -n --hidden --no-ignore-vcs '(^\s*docker\b.*\bopa\b.*\btest\b.*--v1\b|\bopa\s+test\b.*--v1\b)' .github/workflows policies; then
            echo "ERROR: '--v1' flag detected in opa test command."
            exit 1
          fi

          OPA_IMAGE="openpolicyagent/opa@sha256:c0609fecc0924743f8648dc4a035d2f57ca163dc723ed1d13f3197ba5bd122b3"
          docker pull "$OPA_IMAGE"
          opa() { docker run --rm -v "$GITHUB_WORKSPACE:/workspace" -w /workspace "$OPA_IMAGE" "$@"; }

          opa version
          opa fmt --fail policies/
          opa test -v policies/

      # ---------------------------
      # Tests
      # ---------------------------

      - name: Unit tests (spawn_service)
        shell: bash
        run: |
          set -euo pipefail
          python -m unittest discover -s services/spawn_service/tests -v

      - name: Unit tests (orchestrator)
        shell: bash
        env:
          UNIT_TESTS: "1"
          ORCHESTRATOR_INTERNAL_TOKEN: "test-internal"
          OPERATOR_TOKEN: "test-operator"
          SCOREBOARD_INTERNAL_TOKEN: "test-scoreboard"
          SCOREBOARD_ASGI_IMPORT: "services.scoreboard.app.main:app"
        run: |
          set -euo pipefail
          python -m unittest discover -s services/orchestrator/tests -v

      - name: Unit tests (scoreboard)
        shell: bash
        run: |
          set -euo pipefail
          python -m unittest discover -s services/scoreboard/tests -v

      - name: Unit tests (scripts)
        shell: bash
        run: |
          set -euo pipefail
          python -m unittest discover -s scripts/tests -v
